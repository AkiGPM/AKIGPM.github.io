<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="baseImageInput">
    <label for="baseImageUpload">Upload Base Images:</label>
    <input type="file" id="baseImageUpload" accept="image/*" multiple>
  </div>

  <div id="watermarkInput">
    <label for="watermarkUpload">Upload Watermark:</label>
    <input type="file" id="watermarkUpload" accept="image/*">
  </div>

  <div id="watermarkOptions">
    <label for="watermarkSize">Watermark Size:</label>
    <input type="number" id="watermarkSize" value="100" min="1" max="500">
    
    <label for="watermarkPosition">Watermark Position:</label>
    <select id="watermarkPosition">
      <option value="center">Center</option>
      <option value="upper-left">Upper Left</option>
      <option value="upper-right">Upper Right</option>
      <option value="bottom-left">Bottom Left</option>
      <option value="bottom-right">Bottom Right</option>
    </select>
  </div>

  <button id="downloadBaseImage" onclick="downloadBaseImage()">Download Base Image</button>
  <button id="downloadWatermarkedImage" onclick="downloadWatermarkedImage()">Download Watermarked Image</button>

  <canvas id="myCanvas"></canvas>

  <script>
    let baseImages = [];
    let currentBaseImageIndex = 0;
    let watermarkImage;
    let watermarkSize = 100;
    let watermarkPosition = 'center';

    function setup() {
      // Create a small initial canvas
      createCanvas(400, 400);
      background(255);

      // Listen for changes in the base image input
      document.getElementById('baseImageUpload').addEventListener('change', handleBaseImageUpload);

      // Listen for changes in the watermark input
      document.getElementById('watermarkUpload').addEventListener('change', handleWatermarkUpload);

      // Listen for changes in watermark options
      document.getElementById('watermarkSize').addEventListener('input', handleWatermarkSizeChange);
      document.getElementById('watermarkPosition').addEventListener('change', handleWatermarkPositionChange);
    }

    function drawImages() {
      background(255);
      if (baseImages.length > 0) {
        let baseImage = baseImages[currentBaseImageIndex];
        let aspectRatio = baseImage.width / baseImage.height;

        // Set canvas size based on the aspect ratio of the base image
        let canvasWidth, canvasHeight;
        if (width / height > aspectRatio) {
          canvasWidth = height * aspectRatio;
          canvasHeight = height;
        } else {
          canvasWidth = width;
          canvasHeight = width / aspectRatio;
        }

        resizeCanvas(canvasWidth, canvasHeight);

        // Draw the base image
        image(baseImage, 0, 0, canvasWidth, canvasHeight);

        if (watermarkImage) {
          // Draw the watermark based on user-selected size and position
          let x, y;

          if (watermarkPosition === 'center') {
            x = (width - watermarkSize) / 2;
            y = (height - watermarkSize) / 2;
          } else if (watermarkPosition === 'upper-left') {
            x = 0;
            y = 0;
          } else if (watermarkPosition === 'upper-right') {
            x = width - watermarkSize;
            y = 0;
          } else if (watermarkPosition === 'bottom-left') {
            x = 0;
            y = height - watermarkSize;
          } else if (watermarkPosition === 'bottom-right') {
            x = width - watermarkSize;
            y = height - watermarkSize;
          }

          image(watermarkImage, x, y, watermarkSize, watermarkSize);
        }
      }
    }

    function handleBaseImageUpload(event) {
      const files = event.target.files;
      if (files.length > 0) {
        baseImages = Array.from(files).map(file => loadImage(URL.createObjectURL(file), drawImages));
        currentBaseImageIndex = 0;
      }
    }

    function handleWatermarkUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          watermarkImage = loadImage(e.target.result, drawImages);
        };
        reader.readAsDataURL(file);
      }
    }

    function handleWatermarkSizeChange() {
      watermarkSize = parseInt(document.getElementById('watermarkSize').value, 10);
      drawImages();
    }

    function handleWatermarkPositionChange() {
      watermarkPosition = document.getElementById('watermarkPosition').value;
      drawImages();
    }

    function downloadBaseImage() {
      if (baseImages.length > 0) {
        const baseImage = baseImages[currentBaseImageIndex];
        const link = document.createElement('a');
        link.href = baseImage.canvas.toDataURL('image/png');
        link.download = 'base_image.png';
        link.click();
      }
    }

    function downloadWatermarkedImage() {
      if (baseImages.length > 0 && watermarkImage) {
        const baseImage = baseImages[currentBaseImageIndex];
        const canvas = createCanvas(baseImage.width, baseImage.height);
        drawImages();
        const link = document.createElement('a');
        link.href = canvas.elt.toDataURL('image/png');
        link.download = 'watermarked_image.png';
        link.click();
      }
    }

    function draw() {
      // drawImages is called in setup and whenever images are loaded
      // so draw() doesn't need to do anything here
    }
  </script>
</body>
</html>
